#!/bin/bash

set -e

# Define tools directory
TOOLS_DIR="$HOME/android-pentest-tools"
APKTOOL_DIR="$TOOLS_DIR/apktool"
JADX_DIR="$TOOLS_DIR/jadx"
PIDCAT_DIR="$TOOLS_DIR/pidcat"

mkdir -p "$APKTOOL_DIR" "$JADX_DIR" "$PIDCAT_DIR"

echo "[*] Updating package list..."
sudo apt update

echo "[*] Installing required packages..."
sudo apt install -y openjdk-17-jdk adb git python3 python3-pip wget curl unzip

echo "[*] Setting JAVA_HOME..."
export JAVA_HOME=$(readlink -f /usr/bin/java | sed "s:bin/java::")
echo "export JAVA_HOME=$JAVA_HOME" >> ~/.bashrc

# Install Android SDK Command Line Tools
ANDROID_SDK_DIR="$HOME/Android/Sdk"
mkdir -p "$ANDROID_SDK_DIR/cmdline-tools"
cd "$ANDROID_SDK_DIR/cmdline-tools"

echo "[*] Downloading Android SDK command-line tools..."
wget https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -O sdk-tools.zip
unzip sdk-tools.zip -d latest
rm sdk-tools.zip

export ANDROID_HOME=$ANDROID_SDK_DIR
export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$PATH

echo "export ANDROID_HOME=$ANDROID_SDK_DIR" >> ~/.bashrc
echo "export PATH=\$ANDROID_HOME/cmdline-tools/latest/bin:\$ANDROID_HOME/platform-tools:\$PATH" >> ~/.bashrc

# Install APKTool
echo "[*] Installing apktool..."
wget https://bitbucket.org/iBotPeaches/apktool/downloads/apktool_2.9.3.jar -O "$APKTOOL_DIR/apktool.jar"
wget https://raw.githubusercontent.com/iBotPeaches/Apktool/master/scripts/linux/apktool -O "$APKTOOL_DIR/apktool"
chmod +x "$APKTOOL_DIR/apktool"
sudo ln -sf "$APKTOOL_DIR/apktool" /usr/local/bin/apktool
sudo ln -sf "$APKTOOL_DIR/apktool.jar" /usr/local/bin/apktool.jar

# Install jadx
echo "[*] Cloning and building JADX..."
git clone https://github.com/skylot/jadx.git "$JADX_DIR"
cd "$JADX_DIR"
./gradlew dist

# Add JADX to PATH
echo "export PATH=\$PATH:$JADX_DIR/build/jadx/bin" >> ~/.bashrc

# Install pidcat
echo "[*] Installing pidcat..."
wget https://raw.githubusercontent.com/JakeWharton/pidcat/master/pidcat.py -O "$PIDCAT_DIR/pidcat.py"
chmod +x "$PIDCAT_DIR/pidcat.py"
sudo ln -sf "$PIDCAT_DIR/pidcat.py" /usr/local/bin/pidcat

# Install frida and objection
echo "[*] Installing Frida and Objection..."
pip3 install --upgrade frida-tools objection

echo ""
echo "[+] Setup complete."
echo "[!] Please install Genymotion and Burp Suite manually:"
echo "    Genymotion: https://www.genymotion.com/download/"
echo "    Burp Suite: https://portswigger.net/burp"
echo "[-] Restart your terminal or run 'source ~/.bashrc' to apply environment changes."
