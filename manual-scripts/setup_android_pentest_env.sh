#!/bin/bash

set -e

TOOLS_DIR="$HOME/android-pentest-tools"
APKTOOL_DIR="$TOOLS_DIR/apktool"
JADX_DIR="$TOOLS_DIR/jadx"
PIDCAT_DIR="$TOOLS_DIR/pidcat"
ANDROID_SDK_DIR="$HOME/Android/Sdk"

echo "[*] Creating tool directories..."
mkdir -p "$APKTOOL_DIR" "$JADX_DIR" "$PIDCAT_DIR"

echo "[*] Updating package list..."
sudo apt update

echo "[*] Installing required packages..."
sudo apt install -y openjdk-17-jdk adb git python3 python3-pip wget curl unzip

echo "[*] Setting Java 17 as default..."
sudo update-alternatives --install /usr/bin/java java /usr/lib/jvm/java-17-openjdk-amd64/bin/java 1
sudo update-alternatives --install /usr/bin/javac javac /usr/lib/jvm/java-17-openjdk-amd64/bin/javac 1
sudo update-alternatives --set java /usr/lib/jvm/java-17-openjdk-amd64/bin/java
sudo update-alternatives --set javac /usr/lib/jvm/java-17-openjdk-amd64/bin/javac

echo "[*] Java version is now:"
java -version
javac -version

echo "[*] Setting JAVA_HOME..."
export JAVA_HOME="/usr/lib/jvm/java-17-openjdk-amd64"
echo "export JAVA_HOME=$JAVA_HOME" >> ~/.bashrc

# Install Android SDK Command Line Tools
mkdir -p "$ANDROID_SDK_DIR/cmdline-tools"
cd "$ANDROID_SDK_DIR/cmdline-tools"

echo "[*] Downloading Android SDK command-line tools..."
wget https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -O sdk-tools.zip
unzip sdk-tools.zip -d latest
rm sdk-tools.zip

echo "[*] Setting up ANDROID_HOME and PATH..."
export ANDROID_HOME=$ANDROID_SDK_DIR
export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$PATH
echo "export ANDROID_HOME=$ANDROID_HOME" >> ~/.bashrc
echo "export PATH=\$ANDROID_HOME/cmdline-tools/latest/bin:\$ANDROID_HOME/platform-tools:\$PATH" >> ~/.bashrc

# Install APKTool
echo "[*] Installing APKTool..."
wget https://bitbucket.org/iBotPeaches/apktool/downloads/apktool_2.9.3.jar -O "$APKTOOL_DIR/apktool.jar"
wget https://raw.githubusercontent.com/iBotPeaches/Apktool/master/scripts/linux/apktool -O "$APKTOOL_DIR/apktool"
chmod +x "$APKTOOL_DIR/apktool"
sudo ln -sf "$APKTOOL_DIR/apktool" /usr/local/bin/apktool
sudo ln -sf "$APKTOOL_DIR/apktool.jar" /usr/local/bin/apktool.jar

# Install JADX
echo "[*] Cloning and building JADX with Java 17..."
git clone https://github.com/skylot/jadx.git "$JADX_DIR"
cd "$JADX_DIR"
./gradlew clean
./gradlew dist

# Add JADX to PATH
echo "export PATH=\$PATH:$JADX_DIR/build/jadx/bin" >> ~/.bashrc

# Install pidcat
echo "[*] Installing pidcat..."
wget https://raw.githubusercontent.com/JakeWharton/pidcat/master/pidcat.py -O "$PIDCAT_DIR/pidcat.py"
chmod +x "$PIDCAT_DIR/pidcat.py"
sudo ln -sf "$PIDCAT_DIR/pidcat.py" /usr/local/bin/pidcat

# Install frida and objection using pipx
echo "[*] Installing pipx, frida-tools, and objection..."
sudo apt install -y pipx
pipx ensurepath
pipx install frida-tools
pipx install objection

echo ""
echo "[+] Android Pentesting Environment Setup Complete."
echo "[!] Please install Genymotion and Burp Suite manually:"
echo "    Genymotion: https://www.genymotion.com/download/"
echo "    Burp Suite: https://portswigger.net/burp"
echo "[*] Restart your terminal or run: source ~/.bashrc"
